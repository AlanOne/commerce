{% extends "commerce/_layouts/cp" %}

{% set selectedSubnavItem = "promotions" %}

{% set crumbs = [
{ label: "Promotions"|t('commerce'), url: url('commerce/promotions') },
{ label: "Sales"|t('commerce'), url: url('commerce/promotions/sales') },
] %}

{% set fullPageForm = true %}

{% import "_includes/forms" as forms %}
{% import "commerce/_includes/forms/commerceForms" as commerceForms %}


{% set actionClasses = "" %}
{% if (sale.getErrors('discountAmount') or sale.getErrors('discountType')) %}
    {% set actionClasses = "error" %}
{% endif %}

{% set saleClasses = "" %}
{% if(sale.getErrors('name')) %}
    {% set saleClasses = "error" %}
{% endif %}

{% set tabs = {
0: {'label':'Sale'|t('commerce'),'url':'#sale','class': saleClasses},
1: {'label':'Conditions'|t('commerce'),'url':'#conditions'},
2: {'label':'Actions'|t('commerce'),'url':'#actions','class': actionClasses}
} %}


{% block content %}
    <input type="hidden" name="action" value="commerce/sales/save">
    {{ redirectInput('commerce/promotions/sales') }}
    {% if sale.id %}<input type="hidden" name="id" value="{{ sale.id }}">{% endif %}

    <div id="sale">
        {{ forms.textField({
            first: true,
            label: "Name"|t('commerce'),
            instructions: "What this sale will be called in the CP."|t('commerce'),
            id: 'name',
            name: 'name',
            value: sale.name,
            errors: sale.getErrors('name'),
            autofocus: true,
            required: true,
        }) }}

        {{ forms.textField({
            label: "Description"|t('commerce'),
            instructions: "Sale description."|t('commerce'),
            id: 'description',
            name: 'description',
            value: sale.description,
            errors: sale.getErrors('description'),
        }) }}

        {{ forms.checkboxField({
            label: "Enable this sale"|t('commerce'),
            id: 'enabled',
            name: 'enabled',
            value: 1,
            checked: sale.enabled,
            errors: sale.getErrors('enabled')
        }) }}

    </div>

    <div id="conditions" class="hidden">
        {{ forms.dateTimeField({
            label: "Start Date"|t('commerce'),
            instructions: "Date from which the sale will be active. Leave blank for unlimited start date"|t('commerce'),
            id: 'dateFrom',
            name: 'dateFrom',
            value: sale.dateFrom,
            errors: sale.getErrors('dateFrom'),
        }) }}

        {{ forms.dateTimeField({
            label: "End Date"|t('commerce'),
            instructions: "Date when the sale will be finished. Leave blank for unlimited end date"|t('commerce'),
            id: 'dateTo',
            name: 'dateTo',
            value: sale.dateTo,
            errors: sale.getErrors('dateTo'),
        }) }}

        {% if groups|length %}
            {{ forms.multiselectField({
                label: 'User Groups'|t('commerce'),
                instructions: "Groups for which this sale will be applicable to. Leave blank for all groups"|t('commerce'),
                id: 'groups',
                name: 'groups',
                options: groups,
                values: sale.getGroupIds(),
                errors: sale.getErrors('groups'),
                class: 'selectize fullwidth',
            }) }}
        {% endif %}

        {{ forms.multiselectField({
            label: 'Product Types'|t('commerce'),
            instructions: "Product types for which this sale will be applicable to. Leave blank for all product types"|t('commerce'),
            id: 'productTypes',
            name: 'productTypes',
            options: types,
            values: sale.getProductTypeIds(),
            errors: sale.getErrors('productTypes'),
            class: 'selectize fullwidth',
        }) }}

        {{ forms.elementSelectField({
            id: 'products',
            label: 'Products'|t('commerce'),
            name: 'products',
            elements: products ? products : null,
            elementType: productElementType,
            limit: null,
            instructions: "Products for which this sale will be applicable to. Leave blank for all products"|t('commerce'),
            errors: sale.getErrors('products'),
        }) }}

    </div>

    <div id="actions" class="hidden">

        {{ forms.radioGroupField({
            label: 'Discount Type'|t('commerce'),
            instructions: "Select how the discount for this sale will be calculated"|t('commerce'),
            name: 'discountType',
            options: {'flat' : 'Flat'|t('commerce'), 'percent' : 'Percent'|t},
            value: sale.discountType,
            errors: sale.getErrors('discountType'),
            required: true,
        }) }}

        {% set discountAmountValue %}{% spaceless %}
            {% if sale.discountType == 'percent' %}
                {{ sale.discountAmountAsPercent }}
            {% else %}
                {{ sale.discountAmountAsFlat }}
            {% endif %}
        {% endspaceless %}{% endset %}
        {{ forms.textField({
            label: "Discount Amount"|t('commerce'),
            instructions: "Percentage or a flat value of discount (for example: ‘3%’ for 3% off, and ‘10’ for $10 off)."|t('commerce'),
            id: 'discountAmount',
            name: 'discountAmount',
            required: true,
            value: discountAmountValue,
            errors: sale.getErrors('discountAmount'),
        }) }}

    </div>
{% endblock %}

{% js %}
$(function() {
    $('#groups, #productTypes').selectize({
        plugins: ['remove_button'],
        dropdownParent: 'body'
    });
});
{% endjs %}
