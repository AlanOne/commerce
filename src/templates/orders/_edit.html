{% extends "commerce/_layouts/cp" %}

{% set selectedSubnavItem = "orders" %}
{% set bodyClass = (bodyClass is defined ? bodyClass~' ' : '') ~ "commerceorders commerceordersedit" %}

{% set crumbs = [
{    label: "Orders"|t('commerce'), url: url('commerce/orders') }
] %}

{% import "_includes/forms" as forms %}

{% set fullPageForm = true %}
{% set pdfUrl = order.getPdfUrl() %}
{% set saveShortcutRedirect = continueEditingUrl %}
{% hook "cp.commerce.order.edit" %}

{% block header %}
    {{ block('pageTitle') }}
    {% if order.isPaid and order.totalPrice > 0 %}
        <span style="height:32px; box-sizing: border-box;color: darkred; border: 1px solid darkred; border-radius: 3px; letter-spacing:.25em; padding-left:.25em; padding:0px .25em 0px .5em;">{{ 'PAID'|t('commerce') }}</span>
    {% endif %}
    {{ block('contextMenu') }}
    <div class="flex-grow"></div>
    <div class="btn">{{ "Order PDF"|t('commerce') }}</div>
    <div class="flex-grow"></div>
    {{ block('actionButton') }}
{% endblock %}


{% block actionButton %}
    <div class="btngroup">
        <input type="submit" class="btn submit" value="{{ 'Save'|t('commerce') }}">
        <div class="btn submit menubtn"></div>
        <div class="menu">
            <ul>
                <li>
                    <a class="formsubmit" data-redirect="{{ continueEditingUrl|hash }}">
                        {{ "Save and continue editing"|t('commerce') }}
                        {{ forms.optionShortcutLabel('S') }}
                    </a>
                </li>
            </ul>
            {% if order.id %}
                <hr>
                <ul>
                    <li>
                        <a class="formsubmit error" data-action="commerce/orders/delete-order" data-redirect="{{ 'commerce/orders'|hash }}" data-confirm="{{ 'Are you sure you want to delete this order?'|t('commerce') }}">
                            {{ 'Delete'|t('commerce') }}
                        </a>
                    </li>
                </ul>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block content %}


        <div id="orderDetailsTab">
            {% if order.lineItems | length or order.totalPrice > 0 %}
                <div class="order-details">
                    <table id="" class="data fullwidth collapsible">
                        <thead>
                        <tr>
                            <th scope="col">{{ 'Item'|t('commerce') }}</th>
                            <th scope="col">{{ 'Note'|t('commerce') }}</span></th>
                            <th scope="col">{{ 'Price'|t('commerce') }}</span></th>
                            <th scope="col">{{ 'Quantity'|t('commerce') }}</th>
                            <th scope="col">{{ 'Total'|t('commerce') }}</th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                        </tr>
                        </thead>
                        <tbody>

                        {% for lineItem in order.lineItems %}

                            {% set info = [
                            { label: "Description", value: lineItem.description },
                            { label: "Tax Category", value: lineItem.taxCategory.name },
                            { label: "Price", value: lineItem.price|currency(order.currency) },
                            { label: "Sale Amount", value: lineItem.saleAmount|currency(order.currency) },
                            { label: "Sale Price", value: lineItem.salePrice|currency(order.currency) },
                            { label: "Quantity", value: lineItem.qty },
                            { label: "Sub-total", value: lineItem.subtotal|currency(order.currency) },
                            { label: "Total", value: lineItem.subtotal|currency(order.currency) },
                            ] %}

                            <tr class="infoRow" data-id="{{ lineItem.id }}"
                                data-info="{{ info|json_encode }}">
                                <td>
                                    {% if lineItem.purchasable %}
                                        {% if lineItem.purchasable.cpEditUrl %}
                                            <a class="purchasable-link" href="{{ lineItem.purchasable.cpEditUrl }}">{{ lineItem.description }}</a>
                                        {% else %}
                                            <span class="description">{{ lineItem.description }}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="description">{{ lineItem.description }}</span>
                                    {% endif %}
                                    <br><span clas="sku">{{ lineItem.sku }}</span>
                                    {% if lineItem.options|length %}
                                        <a class="fieldtoggle first last"
                                           data-target="info-{{ lineItem.id }}">{{ "Options"|t('commerce') }}</a>
                                        <span id="info-{{ lineItem.id }}"
                                              class="hidden">
                                {% for key, option in lineItem.options %}
                                    {{ key|t('commerce') }}: {% if option is iterable %}
                                    <code>{{ option|json_encode|raw }}</code>{% else %}{{ option }}{% endif %}
                                <br>
                                {% endfor %}
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if lineItem.note %}{{ lineItem.note|nl2br }}{% endif %}
                                </td>
                                <td>
                                    {{ lineItem.salePrice|currency(order.currency) }}
                                </td>
                                <td>{{ lineItem.qty }}</td>
                                <td></td>
                                <td>
                                    <span class="right">{{ lineItem.subtotal|currency(order.currency) }}</span>
                                </td>
                                <td>
                                <span class="tableRowInfo" data-icon="info"
                                      href="#"></span>
                                </td>
                            </tr>
                            {% for adjustment in lineItem.adjustments %}
                                <tr>
                                    <td></td>
                                    <td>
                                        <strong>{{ adjustment.type|title|t('commerce') }} {{ "Adjustment"|t('commerce') }}</strong><br>{{ adjustment.name|title }}
                                        <span class="info"><strong>{{ adjustment.type|title|t('commerce') }} {{ "Adjustment"|t('commerce') }}</strong><br> {{ adjustment.description }}</span>
                                    </td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>
                                        <span class="right">{{ adjustment.amount|currency(order.currency) }}</span>
                                    </td>
                                    <td></td>
                                </tr>
                            {% endfor %}
                        {% endfor %}

                        <tr>
                            <td></td>
                            <td></td>
                            <td>
                            </td>
                            <td></td>
                            <td><strong>{{ "Items Total" }}</strong></td>
                            <td>
                                <span class="right">{{ order.itemTotal|currency(order.currency) }}</span>
                            </td>
                            <td></td>
                        </tr>

                        {% for adjustment in order.orderAdjustments %}
                            <tr>
                                <td>
                                    <strong>{{ adjustment.type|title|t('commerce') }} {{ "Adjustment"|t('commerce') }}</strong><br>{{ adjustment.name|title }}
                                    <span class="info"><strong>{{ adjustment.type|title|t('commerce') }} {{ "Adjustment"|t('commerce') }}</strong><br> {{ adjustment.description }}</span>
                                </td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>
                                    <span class="right">{{ adjustment.amount|currency(order.currency) }}</span>
                                </td>
                                <td></td>
                            </tr>
                        {% endfor %}
                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td></td>
                            <td><h2>{{ "Total Price"|t('commerce') }}</h2></td>
                            <td>
                                <h2 class="right">{{ order.totalPrice|currency(order.currency) }}</h2>
                            </td>
                            <td></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            {% endif %}
        </div>


    {% if orderSettings.getFieldLayout().getTabs()|length %}
            {# Custom fields pane #}
            <div id="fields">
                {% for tab in orderSettings.getFieldLayout().getTabs() %}
                    <div id="tab{{ loop.index }}" class="hidden">
                        {% include "_includes/fields" with {
                        fields: tab.getFields(),
                        element: order,
                        } only %}
                    </div>
                {% endfor %}
            </div>
    {% endif %}

    <div id="transactionsTab" class="hidden">
        {%  include 'commerce/orders/_transactions' %}
    </div>

    <div id="orderHistoryTab" class="hidden">
        {%  include 'commerce/orders/_history' %}
    </div>

    {% hook "cp.commerce.order.edit.main-pane" %}

{% endblock %}

{% block details %}

<div class="meta read-only">
    <div class="data">
        <h5 class="heading">{{ "Status"|t('commerce') }}</h5>
        <div class="value flex">
            <div class="flex-grow">
                {% if order.orderStatus %}
                    <div id="order-status"
                         class="hidden">{{ order.orderStatus.htmlLabel|raw }}
                        <a href="#"
                           class="updatestatus btn small"
                           data-currentStatus="{{ order.orderStatus.attributes|json_encode() }}"
                           data-orderStatuses="{{ orderStatusesJson }}">{{ "Update Status"|t('commerce') }}</a>
                    </div>
                {% else %}
                    <span class="status"></span>
                {% endif %}
            </div>
                <div>
                    <div id="action-menubtn" class="btn menubtn" data-icon="settings" title="{{ 'Actions'|t('app') }}"></div>
                    <div class="menu">
                        <ul>
                            <li><a class="formsubmit" data-action="">Action 1</a></li>
                        </ul>
                        <ul>
                            <li><a class="formsubmit" data-action="">Action 2</a></li>
                        </ul>
                            <hr>
                        <ul>
                            <li><a class="formsubmit" data-action="">Action 3</a></li>
                        </ul>
                    </div>
                    <div id="action-spinner" class="spinner hidden"></div>
                </div>
        </div>
    </div>
    <div class="data first">
        <h5 class="heading">{{ "Reference"|t('commerce') }}</h5>
        <div class="value">{{ order.shortNumber }}</div>
    </div>
    <div class="data">
        <h5 class="heading">{{ "Customer"|t('commerce') }}</h5>
        <div class="value">{% if order.customer.user %}<a href="{{ order.customer.user.cpEditUrl }}">{{ order.email }}</a>{% else %}{{ order.email }}&nbsp;({{ "Guest"|t('commerce') }}) {% endif %}</div>
    </div>
    <div class="data">
        <h5 class="heading">{{ "Order Date"|t('commerce') }}</h5>
        <div class="value">
            <div id="order-completion" class="hidden">
                {% if order.isCompleted %}
                    {{ order.dateOrdered|date('D jS M Y') }}
                {% else %}
                    <div id="order-completionStatus">
                        <a href="#"
                           class="updatecompletion btn small"> {{ "Mark as Complete"|t('commerce') }}</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="data">
        <h5 class="heading">{{ "Total"|t('commerce') }}</h5>
        <div class="value">
            {{ order.totalPrice|currency(order.currency) }}
        </div>
    </div>
    <div class="data">
        <h5 class="heading">{{ "Paid"|t('commerce') }}</h5>
        <div class="value">
            {{ order.totalPaid|currency(order.currency) }} {{ order.datePaid|date('D jS M Y') }}
        </div>
    </div>
    <div class="data">
        <h5 class="heading">{{ "IP Address"|t('commerce') }}</h5>
        <div class="value">
            {{ order.lastIp }}
        </div>
    </div>
    <div class="data">
        <h5 class="heading">{{ "Order Currency"|t('commerce') }}</h5>
        <div class="value">
            {{ order.currency }}
        </div>
    </div>
    {% if order.currency != order.paymentCurrency %}
    <div class="data">
        <h5 class="heading">{{ "Selected Payment Currency"|t('commerce') }}</h5>
        <div class="value">
            {{ order.paymentCurrency }}
        </div>
    </div>
    {% endif %}
    {% if order.couponCode %}
        <div class="data">
            <h5 class="heading">{{ "Selected Coupon"|t('commerce') }}</h5>
            <div class="value">
                {{ order.couponCode }}
            </div>
        </div>
    {% endif %}


</div>

<hr>

<div class="meta">
    {% set address = order.shippingAddress %}
    <div id="shippingAddressBox" class="address-box hidden"
         data-title='{{ "Shipping Address"|t('commerce') }}'
         data-address='{%- if address and address.id -%}{{ address|json_encode_filtered }}{%- endif %}'>
        <div class="address-box-content">
            <div class="address-box-header"></div>
            <div class="address"></div>
        </div>
    </div>
</div>
    <hr>

    <div class="meta">

    {% set address = order.billingAddress %}
    <div id="billingAddressBox" class="address-box hidden"
         data-title='{{ "Billing Address"|t('commerce') }}'
         data-address='{%- if address and address.id -%}{{ address|json_encode_filtered }}{%- endif %}'>
        <div class="address-box-content">
            <div class="address-box-header"></div>
            <div class="address"></div>
        </div>
    </div>
</div><!-- order addresses -->


{% endblock %}

{% js %}
    window.countries = JSON.parse('{{ craft.commerce.countries|values|json_encode|raw }}');
    window.states = JSON.parse('{{ craft.commerce.states|values|json_encode|raw }}');

    $(document).ready(function () {


            new Craft.Commerce.OrderEdit({
                orderId: {{ orderId|e('js') }},
                paymentForm: {
                    errors: {{ paymentMethodsAvailable ? paymentForm.errors|json_encode|raw : []|json_encode|raw }},
                    attributes: {{ paymentMethodsAvailable ? paymentForm.attributes|json_encode|raw : []|json_encode|raw }}
                }
            });

        $.each($('.tableRowInfo'), function () {
            new Craft.Commerce.TableRowAdditionalInfoIcon(this);
        });
    });
{% endjs %}
